<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tembak bola</title>
    <script type="text/javascript" src="../lib/babylon.custom.js"></script>
    <script type="text/javascript" src="../lib/hand-1.3.7.js"></script>
    <script type="text/javascript" src="../lib/cannon2.js"></script>
    <link rel="stylesheet" type="text/css" href="../lib/style_canvas.css" />
</head>
<peach>
    <canvas id="canvas"></canvas>
    <script>
      var canvas = document.getElementById("canvas");
      var engine = new BABYLON.Engine(canvas, true);

      var createScene = function(){
        var scene = new BABYLON.Scene(engine);
        var physicsPlugin = new BABYLON.CannonJSPlugin();
        scene.enablePhysics(new BABYLON.Vector3(0, -9.81, 0), physicsPlugin);
        var camera2;
        camera2 = new BABYLON.ArcRotateCamera("camera2", BABYLON.Tools.ToRadians(270), BABYLON.Tools.ToRadians(45), 20, new BABYLON.Vector3.Zero(), scene);
        camera2.setPosition(new BABYLON.Vector3(0,35,-70));
        camera2.attachControl(canvas, false);

        var light = new BABYLON.HemisphericLight("light1", new BABYLON.Vector3(0,5,0), scene);
        light.intensity = 0.9;

        var ground = BABYLON.Mesh.CreateGround("ground", 1000, 1000, 2, scene);
        ground.setPhysicsState({impostor: BABYLON.PhysicsEngine.BoxImpostor, mass: 0, restitution: 0.5, friction: 0.1});

        // var sphere1 = BABYLON.Mesh.CreateSphere("sphere1", 16, 2, scene);
        // sphere1.position = new BABYLON.Vector3(0, 5, 0);
        // sphere1.setPhysicsState({impostor: BABYLON.PhysicsEngine.SphereImpostor, mass: 1, restitution: 0.0, friction: 0.0});

        var peach = BABYLON.Mesh.CreateSphere("peach", 16, 5, scene);
        peach.position = new BABYLON.Vector3(0, 1.5, 0);
        peach.setPhysicsState({impostor: BABYLON.PhysicsEngine.SphereImpostor, mass: 5, restitution: 0.5, friction: 1, linearDamping: 0.5});

        var arrow = BABYLON.Mesh.CreateBox("arrow", 0.5, scene);
        arrow.scaling.z = 20;
        arrow.position = new BABYLON.Vector3(0, 1, 0);
        arrow.setPivotMatrix(BABYLON.Matrix.Translation(0, 0, 0.25));

        var arrowhead = BABYLON.MeshBuilder.CreateCylinder("arrowhead", {diameterTop: 1.5, height: 1.5, diameterBottom: 0, tessellation: 4}, scene);
        arrowhead.rotation.x = BABYLON.Tools.ToRadians(-90);
        arrowhead.position.z = 5.5/20;
        arrowhead.scaling.y = 1/20;
        arrowhead.parent = arrow;

        var goal = BABYLON.Mesh.CreateBox("goal", 4, scene);
        goal.position = new BABYLON.Vector3(0, 2, 200);

        var material1 = new BABYLON.StandardMaterial("material1",scene);
        material1.diffuseColor = BABYLON.Color3.Blue();
        material1.emmisiveColor = BABYLON.Color3.Blue();
        material1.specularColor = new BABYLON.Color3(0,0,0);
        material1.specularPower = 5;
        material1.alpha = 1.0;

        var material2 = new BABYLON.StandardMaterial("material2",scene);
        // material1.wireframe = true;
        material2.diffuseColor = BABYLON.Color3.Red();
        material2.emmisiveColor = BABYLON.Color3.Red();
        material2.alpha = 1.0;

        var groundMaterial = new BABYLON.StandardMaterial("groundMaterial", scene);
        groundMaterial.diffuseTexture = new BABYLON.Texture("grass.png", scene);
        groundMaterial.specularPower = 1000;
        // sphere1.material = material1;
        //bcamera2.parent = pyramid;
        peach.material = material2;
        ground.material = groundMaterial;

        BABYLON.SceneLoader.ImportMesh("","assets/", "basket.babylon", scene, function (newMeshes, particleSystems) {
  		    model = newMeshes[0];
  		    model.position = new BABYLON.Vector3(0, 5, 0);
          model.scaling = new BABYLON.Vector3(100, 100, 100);
        });

        // camera2 = new BABYLON.FollowCamera("camera2", new BABYLON.Vector3(0,15,-30), scene);
        // camera2.lockedTarget = sphere1;
        // camera2.radius = 30;
        // camera2.heightOffset = 8;
        // camera2.rotationOffset = 180;

        return scene;
      }


      var scene = createScene();
      var switcher = 1;
      var map = {};
      var point = -1;

      var peach = scene.getMeshByName("peach");
      var arrow = scene.getMeshByName("arrow");
      var goal = scene.getMeshByName("goal");

      var speed = 50;
      //adjust direction of throw
      var angle = 0;
      var anglevertical = 45;
      var phyEng = scene.getPhysicsEngine();
      var thrown = false;
      var wind = 0;
      var change = 0;

      //ScoreBoard
      var scoreBoard = new BABYLON.ScreenSpaceCanvas2D(scene, {
        id: "canvas2",  parent: canvas,x:0, y:575,
        size: new BABYLON.Size(300, 100),
        backgroundFill: "#4040408F",
        backgroundRoundRadius: 50,
      });
      var score = new BABYLON.Text2D("Score: "+point.toString()+ "  ||  Wind: "+wind.toString(), {
          parent: scoreBoard,
          id: "score",
          marginAlignment: "h: center, v:center",
          fontName: "20pt Arial",
      });

      //debug
      // var radangle;
      // var radanglevertical;
      // var direction;

      window.onkeydown = window.onkeyup = function(event){
        event = event || window.event;
        map[event.keyCode] = event.type == 'keydown';
        //W
        if(map[87] && anglevertical < 85){
          anglevertical+=2
        }
        //S
        if(map[83] && anglevertical > 0){
          anglevertical-=2
        }
        //A
        if(map[65] && angle > -90){
          angle-=1
        }
        //D
        if(map[68] && angle < 90){
          angle+=1
        }
        //space - throwing
        if(map[32]){
          //increase power while held
          speed+=10;
        }else{
          //when released, launch ball
          if(peach.position.z <= 0 && speed > 50){
            //remove arrow
            arrow.position.y = -100;
            //apply wind
            phyEng.setGravity(new BABYLON.Vector3(wind, -9.81, 0));
            thrown = true;
            //finding throw direction
            var radangle = BABYLON.Tools.ToRadians(angle);
            var radanglevertical = BABYLON.Tools.ToRadians(anglevertical);
            var direction = new BABYLON.Vector3(speed * Math.sin(radangle), speed * Math.tan(radanglevertical), speed * Math.cos(radangle));
            direction.scaleInPlace(speed / Math.sqrt(speed * Math.sin(radangle) * speed * Math.sin(radangle) + speed * Math.tan(radanglevertical) * speed * Math.tan(radanglevertical) + speed * Math.cos(radangle) * speed * Math.cos(radangle)));
            //throwing
            peach.applyImpulse(direction, peach.position);
            //reset speed
            speed = 50;
          }
        }
        //R - reset object
        if(map[82]){
          //remove then create new peach object
          score.text = "Score: "+point.toString()+ "  ||  Wind: "+wind.toString();
          peach.dispose();
          peach = BABYLON.Mesh.CreateSphere("peach", 16, 2, scene);
          peach.position = new BABYLON.Vector3(0, 1.5, 0);
          peach.setPhysicsState({impostor: BABYLON.PhysicsEngine.SphereImpostor, mass: 5, restitution: 0.5, friction: 1, linearDamping: 0.5});

          var material2 = new BABYLON.StandardMaterial("material2",scene);
          material2.diffuseColor = BABYLON.Color3.Red();
          material2.emmisiveColor = BABYLON.Color3.Red();
          material2.alpha = 1.0;
          peach.material = scene.getMaterialByName("material2");

          //return arrow
          arrow.position.y = 1;

          //remove wind
          phyEng.setGravity(new BABYLON.Vector3(0, -9.81, 0));

          //reset speed
          speed = 50;
          // peach.position = new BABYLON.Vector3(0, 1.5, 0);
          // peach.mass = 0;
          // peach.updateMassProperties();
          // peach.velocity.set(0,0,0);
          // peach.angularVelocity.set(0,0,0);
        }
      }

      engine.runRenderLoop(function(){
        if(thrown){
          thrown = false;
          change = Math.random()*10;
          if(change <=5){
            wind = Math.floor(Math.random()*10.9)-5;
          }
        }

        //if touch goal
        if(peach.intersectsMesh(goal, false)){
          //increase point
          point++;
          score.text = "Score: "+point.toString()+ "  ||  Wind: "+wind.toString();
          //reset peach
          peach.dispose();
          peach = BABYLON.Mesh.CreateSphere("peach", 16, 2, scene);
          peach.position = new BABYLON.Vector3(0, 1.5, 0);
          peach.setPhysicsState({impostor: BABYLON.PhysicsEngine.SphereImpostor, mass: 5, restitution: 0.5, friction: 1, linearDamping: 0.5});

          var material2 = new BABYLON.StandardMaterial("material2",scene);
          material2.diffuseColor = BABYLON.Color3.Red();
          material2.emmisiveColor = BABYLON.Color3.Red();
          material2.alpha = 1.0;
          peach.material = scene.getMaterialByName("material2");

          //return arrow
          arrow.position.y = 1;

          //reset wind
          phyEng.setGravity(new BABYLON.Vector3(0, -9.81, 0));

          //reset speed
          speed = 50;
        }
        //changing direction of arrow
        arrow.rotation.y = BABYLON.Tools.ToRadians(angle);
        arrow.rotation.x = BABYLON.Tools.ToRadians(-anglevertical);


        scene.render();
      });

      window.addEventListener("resize", function(){
        engine.resize();
      });
    </script>
</peach>
</html>
